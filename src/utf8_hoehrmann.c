// taken from: https://bjoern.hoehrmann.de/utf-8/decoder/dfa/
#define UTF8_ACCEPT 0
#define UTF8_REJECT 16
#define UTF8_TERMINAL_START 16
#include <stdint.h>

// states are pre multiplied with width
// so instead of doing state = table[state*width+ch]
// we can do state = table[state + ch]
static const uint8_t utf8d[] = {
// CHARACTER CLASSES
//         0   1   2   3   4   5   6   7   8   9   a   b   c   d   e   f
/* 0 */  0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
/* 1 */  0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
/* 2 */  0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
/* 3 */  0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
/* 4 */  0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
/* 5 */  0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
/* 6 */  0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
/* 7 */  0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
/* 8 */  0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,
/* 9 */  0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,
/* a */  0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,
/* b */  0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,
/* c */  0x8,0x8,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,
/* d */  0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,
/* e */  0xa,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x4,0x3,0x3,
/* f */  0xb,0x6,0x6,0x6,0x5,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,

// DFA
//          0    1    2    3    4    5    6    7    8    9    a    b    c    d    e    f
/* s0 */ 0x00,0x10,0x20,0x30,0x50,0x80,0x70,0x10,0x10,0x10,0x40,0x60,0x10,0x10,0x10,0x10,
/* s1 */ 0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,
/* s2 */ 0x10,0x00,0x10,0x10,0x10,0x10,0x10,0x00,0x10,0x00,0x10,0x10,0x10,0x10,0x10,0x10,
/* s3 */ 0x10,0x20,0x10,0x10,0x10,0x10,0x10,0x20,0x10,0x20,0x10,0x10,0x10,0x10,0x10,0x10,
/* s4 */ 0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x20,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,
/* s5 */ 0x10,0x20,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x20,0x10,0x10,0x10,0x10,0x10,0x10,
/* s6 */ 0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x30,0x10,0x30,0x10,0x10,0x10,0x10,0x10,0x10,
/* s7 */ 0x10,0x30,0x10,0x10,0x10,0x10,0x10,0x30,0x10,0x30,0x10,0x10,0x10,0x10,0x10,0x10,
/* s8 */ 0x10,0x30,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,
};

void* utf8_decode_dfa(void* buff, uint32_t* c, uint32_t* e) {
    uint8_t* b = buff;
    uint32_t type = utf8d[b[0]];
    uint32_t state = 0;

    state = utf8d[256 + state + type];
    *c = (0xff >> type) & b[0];
    ++b;

    while (state > UTF8_TERMINAL_START) {
        type = utf8d[b[0]];
        state = utf8d[256 + state + type];
        *c = (*c << 6) | (b[0] & 0x3f);
        ++b;
    }

    *e = state;

    return b;
}
